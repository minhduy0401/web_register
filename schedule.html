<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>L·ªãch l√†m - Demo</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 1100px;
      margin: 0 auto;
      padding: 40px;
      animation: slideIn 0.5s ease-out;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    h2 { 
      text-align: center;
      color: #667eea;
      margin-bottom: 30px;
      font-size: 28px;
      font-weight: 600;
    }
    
    .btn { 
      padding: 12px 24px;
      cursor: pointer;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      transition: all 0.3s ease;
      margin-bottom: 24px;
      display: inline-block;
    }
    
    .btn-back {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
    
    .btn-back:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }
    
    .table-container {
      overflow-x: auto;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    table { 
      width: 100%;
      border-collapse: collapse;
      background: white;
    }
    
    th, td { 
      border: 1px solid #e0e0e0;
      padding: 16px 12px;
      text-align: center;
    }
    
    th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 13px;
    }
    
    td {
      font-size: 14px;
      color: #555;
    }
    
    tbody tr {
      transition: all 0.3s ease;
    }
    
    tbody tr:nth-child(even) {
      background: #f8f9fa;
    }
    
    tbody tr:hover {
      background: #e3e8ff;
      transform: scale(1.01);
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
    }
    
    .btn-secondary {
      background: white;
      color: #667eea;
      border: 2px solid #667eea;
    }
    
    .btn-secondary:hover {
      background: #667eea;
      color: white;
      transform: translateY(-2px);
    }
    
    .user-info-bar {
      text-align: center;
      margin-bottom: 20px;
      padding: 12px;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 10px;
      border: 2px solid #e0e0e0;
    }
    
    .user-info-bar .user-name {
      color: #667eea;
      font-weight: 600;
      font-size: 16px;
    }
    
    .shift-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .shift-morning {
      background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
      color: #d63031;
    }
    
    .shift-afternoon {
      background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
      color: white;
    }
    
    .shift-evening {
      background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%);
      color: white;
    }
    
    @media print {
      body {
        background: white;
        padding: 0;
      }
      
      .container {
        box-shadow: none;
        padding: 20px;
      }
      
      .user-info-bar,
      .btn {
        display: none !important;
      }
      
      h2 {
        color: #000;
      }
      
      table {
        page-break-inside: avoid;
      }
      
      tbody tr:hover {
        transform: none;
        box-shadow: none;
      }
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 20px;
      }
      
      h2 {
        font-size: 22px;
      }
      
      table {
        font-size: 12px;
      }
      
      th, td {
        padding: 10px 6px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üìÖ L·ªãch l√†m ƒë√£ s·∫Øp</h2>

    <!-- User info and logout -->
    <div class="user-info-bar">
      <span class="user-name">üë§ <span id="userName"></span></span>
      <button class="btn btn-secondary" id="logoutBtn" style="margin-left: 10px; padding: 8px 16px; display: inline-block; width: auto; margin-top: 0;">üö™ ƒêƒÉng xu·∫•t</button>
    </div>

    <button class="btn btn-back" id="backBtn">‚Üê Quay l·∫°i qu·∫£n l√Ω</button>
    
    <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
      <button class="btn btn-success" id="exportExcelBtn">üìä Xu·∫•t Excel</button>
      <button class="btn btn-info" id="exportPDFBtn">üìÑ Xu·∫•t PDF</button>
      <button class="btn btn-primary" id="printBtn">üñ®Ô∏è In l·ªãch</button>
    </div>
    
    <div class="table-container">
      <table id="scheduleTable">
        <thead><tr><th>üìÖ Ng√†y</th><th>‚è∞ Ca</th><th>üë§ Nh√¢n vi√™n</th><th>üìù Ghi ch√∫</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    // ---- Authentication check ----
    const LS_AUTH = 'shift_auth_user';
    
    function checkAuth() {
      const authData = localStorage.getItem(LS_AUTH);
      if (!authData) {
        window.location.href = 'login.html';
        return null;
      }
      try {
        const user = JSON.parse(authData);
        // Ch·ªâ admin m·ªõi v√†o ƒë∆∞·ª£c trang n√†y
        if (user.role !== 'admin') {
          alert('B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y!');
          window.location.href = 'register.html';
          return null;
        }
        return user;
      } catch (e) {
        localStorage.removeItem(LS_AUTH);
        window.location.href = 'login.html';
        return null;
      }
    }

    function logout() {
      if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')) {
        localStorage.removeItem(LS_AUTH);
        window.location.href = 'login.html';
      }
    }

    // Initialize page with auth
    const currentUser = checkAuth();
    if (currentUser) {
      document.getElementById('userName').textContent = currentUser.name;
    }

    document.getElementById('logoutBtn').addEventListener('click', logout);

    // ---- Original code ----
    const LS_SCHEDULE = 'shift_schedule_demo';
    function loadSchedule(){ const raw = localStorage.getItem(LS_SCHEDULE); return raw?JSON.parse(raw):[]; }

    function render() {
      const sch = loadSchedule();
      const tbody = document.querySelector('#scheduleTable tbody');
      tbody.innerHTML = '';
      if (sch.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="padding: 40px; color: #999;">Ch∆∞a c√≥ l·ªãch (h√£y ch·∫°y "T·ª± ph√¢n ca" ·ªü trang qu·∫£n l√Ω)</td></tr>';
        return;
      }
      // sort by date then by start time if available
      sch.sort((a,b) => {
        const dateCompare = a.date.localeCompare(b.date);
        if (dateCompare !== 0) return dateCompare;
        // N·∫øu c√≥ start_time th√¨ sort theo gi·ªù
        if (a.start_time && b.start_time) {
          return a.start_time.localeCompare(b.start_time);
        }
        return a.user_name.localeCompare(b.user_name);
      });

      sch.forEach(s => {
        const tr = document.createElement('tr');
        // Hi·ªÉn th·ªã gi·ªù t√πy ch·ªânh ho·∫∑c badge cho ca c≈©
        let shiftDisplay;
        if (s.shift_time) {
          // Gi·ªù t√πy ch·ªânh
          shiftDisplay = `<span style="color: #667eea; font-weight: 600;">‚è∞ ${s.shift_time}</span>`;
        } else {
          // Ca c·ªë ƒë·ªãnh c≈© (n·∫øu c√≤n)
          const shiftLabels = {
            morning: 'üåÖ Ca s√°ng',
            afternoon: '‚òÄÔ∏è Ca chi·ªÅu', 
            evening: 'üåô Ca t·ªëi'
          };
          const shiftClass = `shift-${s.shift}`;
          const shiftLabel = shiftLabels[s.shift] || s.shift;
          shiftDisplay = `<span class="shift-badge ${shiftClass}">${shiftLabel}</span>`;
        }
        
        tr.innerHTML = `<td><strong>${s.date}</strong></td><td>${shiftDisplay}</td><td>${s.user_name}</td><td>${s.assigned_by}</td>`;
        tbody.appendChild(tr);
      });
    }

    document.getElementById('backBtn').addEventListener('click', ()=> location.href='admin.html');

    // Export to Excel (CSV format)
    document.getElementById('exportExcelBtn').addEventListener('click', function() {
      const sch = loadSchedule();
      if (sch.length === 0) {
        alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!');
        return;
      }

      let csv = 'Ng√†y,Gi·ªù l√†m,Nh√¢n vi√™n,Ghi ch√∫\n';
      sch.forEach(s => {
        const shiftTime = s.shift_time || s.shift || '';
        csv += `"${s.date}","${shiftTime}","${s.user_name}","${s.assigned_by}"\n`;
      });

      const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `lich_lam_${new Date().toISOString().slice(0,10)}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      alert('‚úÖ ƒê√£ xu·∫•t file Excel!');
    });

    // Export to PDF (simple HTML to print)
    document.getElementById('exportPDFBtn').addEventListener('click', function() {
      const sch = loadSchedule();
      if (sch.length === 0) {
        alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!');
        return;
      }

      let htmlContent = `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="utf-8">
          <title>L·ªãch l√†m vi·ªác</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 20px; }
            h1 { text-align: center; color: #667eea; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
            th { background: #667eea; color: white; }
            tr:nth-child(even) { background: #f2f2f2; }
            .footer { margin-top: 30px; text-align: center; font-size: 12px; color: #666; }
          </style>
        </head>
        <body>
          <h1>üìÖ L·ªäCH L√ÄM VI·ªÜC</h1>
          <p><strong>Ng√†y xu·∫•t:</strong> ${new Date().toLocaleString('vi-VN')}</p>
          <table>
            <thead>
              <tr>
                <th>Ng√†y</th>
                <th>Gi·ªù l√†m</th>
                <th>Nh√¢n vi√™n</th>
                <th>Ghi ch√∫</th>
              </tr>
            </thead>
            <tbody>
      `;

      sch.forEach(s => {
        const shiftTime = s.shift_time || s.shift || '';
        htmlContent += `
          <tr>
            <td>${s.date}</td>
            <td>${shiftTime}</td>
            <td>${s.user_name}</td>
            <td>${s.assigned_by}</td>
          </tr>
        `;
      });

      htmlContent += `
            </tbody>
          </table>
          <div class="footer">
            <p>H·ªá th·ªëng qu·∫£n l√Ω ca l√†m vi·ªác - T·∫°o b·ªüi Admin</p>
          </div>
        </body>
        </html>
      `;

      const blob = new Blob([htmlContent], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `lich_lam_${new Date().toISOString().slice(0,10)}.html`;
      link.click();
      
      alert('‚úÖ ƒê√£ xu·∫•t file PDF (HTML)!\n\nM·ªü file v√† d√πng tr√¨nh duy·ªát ƒë·ªÉ in ra PDF (Ctrl+P > Save as PDF)');
    });

    // Print functionality
    document.getElementById('printBtn').addEventListener('click', function() {
      window.print();
    });

    window.addEventListener('load', render);
  </script>
</body>
</html>
